#' Model trajectories using DiffusionMaps
#'
#' Subset cells per trajectory and project in DiffusionMaps space
#'
#' @param data Processed Seurat object: output from \code{\link{process_data}}
#'
#' @details This function creates a list of subsetted Seurat objects (per
#'   trajectory) and projects the first 25 integrated principal components for each object in
#'   DiffusionMaps space using the \code{destiny} package. The resulting cell
#'   embeddings are then stashed in the "reductions" slot of the corresponding
#'   Seurat objects.
#'
#' @return A list of Seurat objects (per trajectory) which have DiffusionMaps
#'   embeddings stored in a dimensional reduction slot. Accessible via
#'   \code{SeuratObject::Embeddings(object, reduction = "dc")}
#' @export
#' @concept analysis
#'
#' @examples
#' \dontrun{
#' object <- process_data()
#'
#' object.list <- model_diffusion(data=object)
#'
#' slingshot.models <- model_slingshot(data=object.list)}

model_diffusion <- function(data=NULL){
  message("Running DiffusionMaps on secretory trajectory...")
  srat.secretory <- subset(data, cells=Seurat::WhichCells(data, idents = c("ISC","TA2","Secretory progenitor","Goblet","EEC","Tuft")))
  dif <- destiny::DiffusionMap(srat.secretory@reductions$pca@cell.embeddings[,1:25])
  suppressWarnings(srat.secretory[["dc"]] <- Seurat::CreateDimReducObject(embeddings = as.matrix(dif@eigenvectors), key = "DC", assay = Seurat::DefaultAssay(srat.secretory)))

  message("Running DiffusionMaps on enterocyte trajectory...")
  srat.ec <- subset(data, cells=Seurat::WhichCells(data, idents = c("ISC","TA2","Early EC","EC")))
  dif <- destiny::DiffusionMap(srat.ec@reductions$pca@cell.embeddings[,1:25])
  suppressWarnings(srat.ec[["dc"]] <- Seurat::CreateDimReducObject(embeddings = as.matrix(dif@eigenvectors), key = "DC", assay = Seurat::DefaultAssay(srat.ec)))

  message("Running DiffusionMaps on Paneth trajectory...")
  srat.pan <- subset(data, cells=Seurat::WhichCells(data, idents = c("ISC","TA2","Secretory progenitor","Paneth")))
  dif <- destiny::DiffusionMap(srat.pan@reductions$pca@cell.embeddings[,1:25])
  suppressWarnings(srat.pan[["dc"]] <- Seurat::CreateDimReducObject(embeddings = as.matrix(dif@eigenvectors), key = "DC", assay = Seurat::DefaultAssay(srat.pan)))

  message("Running DiffusionMaps on stem trajectory...")
  srat.stem <- subset(data, cells=Seurat::WhichCells(data, idents = c("ISC","TA2","TA1")))
  dif <- destiny::DiffusionMap(srat.stem@reductions$pca@cell.embeddings[,1:25])
  suppressWarnings(srat.stem[["dc"]] <- Seurat::CreateDimReducObject(embeddings = as.matrix(dif@eigenvectors), key = "DC", assay = Seurat::DefaultAssay(srat.stem)))

  srat.trajectories <- list("secretory"=srat.secretory,
                            "ec"=srat.ec,
                            "paneth"=srat.pan,
                            "stem"=srat.stem)
  return(srat.trajectories)
}


#' Infer trajectories using slingshot
#'
#' A function to run slingshot on DiffusionMaps modeled trajectories
#'
#' @details This function calls slingshot on each object in the list of Seurat
#'   objects generated by \code{\link{model_diffusion}}, using the first 2
#'   DiffusionMaps components as input. In all cases the "ISC" cluster is used as the starting point for defining lineages
#'
#' @param data Output from \code{\link{model_diffusion}}; List of Seurat objects
#'   for which DiffusionMaps embeddings have been calculated.
#'
#' @return A list of slingshot objects corresponding to the list of Seurat
#'   objects used as input
#' @export
#'
#' @examples
#' \dontrun{
#' object <- process_data()
#'
#' object.list <- model_diffusion(data=object)
#'
#' slingshot.models <- model_slingshot(data=object.list)}

model_slingshot <- function(data=NULL){
  sling <- lapply(seq_along(data), function(x){
    slingshot::slingshot(data[[x]]@reductions$dc@cell.embeddings[,1:2],Seurat::Idents(data[[x]]),start.clus = "ISC")
  })

  names(sling) <- names(data)
  return(sling)
}
